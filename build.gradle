buildscript {
	repositories {
		gradlePluginPortal()
	}
	dependencies {
		classpath 'com.modrinth.minotaur:Minotaur:2.4.3'
		classpath "com.github.breadmoirai:github-release:2.4.1"
	}
}

plugins {
	id 'maven-publish'
	alias libs.plugins.loom
}

if (System.getenv("MODRINTH_TOKEN")) {
	apply plugin: "com.modrinth.minotaur"
}
if (System.getenv("GITHUB_TOKEN")) {
	apply plugin: "com.github.breadmoirai.github-release"
}

archivesBaseName = project.archives_base_name

def mc_major = '1.19'
def nbt_crafting = '2'
def mc = mc_major + '.2'
def default_branch = 'nbtc2'

def origVersion = project.version
project.version = project.version + "+nbtc" + nbt_crafting
group = project.maven_group

repositories {
	maven { url "https://maven.shedaniel.me/" }
	maven { url "https://maven.terraformersmc.com/" }
	maven { url "https://jitpack.io" }
	maven { url "https://api.modrinth.com/maven" }
	maven { url 'https://repo.sleeping.town' }
	maven { url 'https://maven.blamejared.com' }
	maven { url "https://maven.jamieswhiteshirt.com/libs-release" }
	maven { url 'https://ladysnake.jfrog.io/artifactory/mods' }
	maven { url 'https://maven.cafeteria.dev' }
	// Create
	maven { url "https://dvs1.progwml6.com/files/maven/" }
	maven { url "https://maven.parchmentmc.org" }
	maven { url "https://maven.quiltmc.org/repository/release" }
	maven { url "https://mvn.devos.one/snapshots/" }
	maven { url "https://cursemaven.com" }
	maven { url "https://raw.githubusercontent.com/Fuzss/modresources/main/maven/" }
	maven { url "https://maven.tterrag.com/" }
}

// All the dependencies are declared at gradle/libs.version.toml and referenced with "libs.<id>"
// See https://docs.gradle.org/current/userguide/platforms.html for information on how version catalogs work.
dependencies {
	// // Base // //
	minecraft libs.mc
	mappings variantOf(libs.qm) { classifier "intermediary-v2" }
	modImplementation libs.ql
	modImplementation libs.qsl
	modImplementation libs.qfapi

	// // Libraries // //
	modCompileOnly libs.emi
	modLocalRuntime libs.emi

	// // Compat Dependencies // //
	modImplementation libs.lib39aqi
	modImplementation libs.lib39core
	modImplementation libs.lib39crowbar
	modImplementation libs.lib39deferral
	modImplementation libs.lib39dessicant
	modImplementation libs.lib39fractal
	modImplementation libs.lib39gesundheit
	modImplementation libs.lib39keygen
	modImplementation libs.lib39lockpick
	modImplementation libs.lib39machination
	modImplementation libs.lib39mesh
	modImplementation libs.lib39phantom
	modImplementation libs.lib39recoil
	modImplementation libs.lib39ripple
	modImplementation libs.lib39sandman
	modImplementation libs.lib39tunnel
	modImplementation libs.lib39util
	modImplementation libs.lib39waypoint
	modImplementation libs.lib39weld

	modApi libs.forgeConfigApiPort

	// // Compat // //
	modImplementation libs.farmersDelight
	modImplementation libs.campanion
	modImplementation libs.halfdoors
	modImplementation libs.chalk
	modImplementation libs.consistencyPlus
	modImplementation libs.yttr
	modImplementation libs.botania
	modImplementation libs.create
}

processResources {
	final Map<String, String> map = [
		"version"        : version.toString(),
		"mc"             : libs.versions.mc.get(),
		"ql"             : libs.versions.ql.get(),
		"qsl"            : libs.versions.qsl.get(),
		"qfapi"          : libs.versions.qfapi.get(),
		"emi"            : libs.versions.emi.get(),
		"farmersDelight" : libs.versions.farmersDelight.get(),
		"campanion"      : libs.versions.campanion.get(),
		"yttr"           : libs.versions.yttr.get(),
		"create"         : libs.versions.create.get(),
		"botania"        : libs.versions.botania.get(),
		"chalk"          : libs.versions.chalk.get(),
		"consistencyPlus": libs.versions.consistencyPlus.get(),
		"halfdoors"      : libs.versions.halfdoors.get(),
	]

	inputs.properties(map)
	filesMatching('quilt.mod.json') { expand(map) }
}

tasks.withType(JavaCompile).configureEach {
	it.options.encoding = "UTF-8"
	it.options.release = 17
}

java {
	withSourcesJar()

	// If this mod is going to be a library, then it should also generate Javadocs in order to aid with development.
	// Uncomment this line to generate them.
	// withJavadocJar()
}

jar {
	from("LICENSE.txt") {
		rename { "${it}_${archivesBaseName}" }
	}
}

// Configure the maven publication
publishing {
	publications {
		mavenJava(MavenPublication) {
			from components.java
		}
	}

	// See https://docs.gradle.org/current/userguide/publishing_maven.html for information on how to set up publishing.
	repositories {

	}
}

if (System.getenv("MODRINTH_TOKEN")) {
	modrinth {
		token = System.getenv("MODRINTH_TOKEN")
		projectId = 'tinkerers-smithing'
		versionNumber = project.version
		versionName = origVersion
		versionType = 'release'
		uploadFile = remapJar
		gameVersions = [mc]
		loaders = ['quilt']
		detectLoaders = false
		dependencies {
			required.project "nbt-crafting"
		}
		changelog = "Changelog: https://github.com/sisby-folk/tinkerers-smithing/releases/tag/v" + origVersion
		syncBodyFrom = rootProject.file("README.md").text
	}
}

if (System.getenv("GITHUB_TOKEN")) {
	githubRelease {
		token System.getenv("GITHUB_TOKEN")
		owner "sisby-folk"
		repo "tinkerers-smithing"
		tagName 'v' + origVersion
		releaseName origVersion
		targetCommitish default_branch
		draft false
		prerelease false
		releaseAssets remapJar.archiveFile
		allowUploadToExisting true
		generateReleaseNotes true
	}
	tasks.githubRelease.dependsOn remapJar
}
